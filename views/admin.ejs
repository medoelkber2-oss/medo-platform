<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ø³ØªØ± Ù…ÙŠØ¯Ùˆ - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
    * { font-family: 'Cairo', sans-serif; }
    body { background: #0f172a; color: white; padding: 20px; }
    
    /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .card-custom { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .stat-card { background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 15px; }
    .stat-card.green { background: linear-gradient(135deg, #10b981, #059669); }
    .online-dot { width: 10px; height: 10px; background: #10b981; border-radius: 50%; display: inline-block; margin-left: 5px; box-shadow: 0 0 8px #10b981; }
    .notify-item { cursor: pointer; transition: 0.3s; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px; }
    .notify-item:hover { background: rgba(255,255,255,0.1); }
    .table { color: white !important; }
    .badge-course { background: #3b82f6; font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø­ØªØ±Ø§ÙÙŠØ© ğŸš€</h2>
    <div>
      <span class="badge bg-info"><%= stats.activeStudents %> Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span>
      <a href="/logout" class="btn btn-danger btn-sm">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3 col-6">
      <div class="stat-card green">
        <h3><%= stats.activeStudents %></h3>
        <p>ğŸŸ¢ Ù…ØªØµÙ„ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stat-card">
        <h3><%= stats.totalStudents %></h3>
        <p>ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <h3><%= stats.totalCourses %></h3>
        <p>ğŸ“š Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</p>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stat-card" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
        <h3><%= stats.unusedCodes %></h3>
        <p>ğŸ”‘ Ø£ÙƒÙˆØ§Ø¯ Ù…ØªØ§Ø­Ø©</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card-custom">
        <h5>ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ† (<%= students.length %>)</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th>Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„ØªØ­ÙƒÙ…</th>
              </tr>
            </thead>
            <tbody>
              <% if (students && students.length > 0) { %>
                <% students.forEach(s => { 
                   let courseCount = 0;
                   try { courseCount = Object.keys(JSON.parse(s.courses || '{}')).length; } catch(e){}
                %>
                  <tr>
                    <td>
                      <div class="fw-bold"><%= s.username %></div>
                      <small class="text-muted"><%= s.email %></small>
                    </td>
                    <td><span class="badge badge-course"><%= courseCount %> ÙƒÙˆØ±Ø³</span></td>
                    <td>
                      <% if(s.isOnline) { %>
                        <span class="online-dot"></span> <small>Ù…ØªØµÙ„</small>
                      <% } else { %>
                        <small class="text-muted">Ø£ÙˆÙÙ„Ø§ÙŠÙ†</small>
                      <% } %>
                    </td>
                    <td>
                      <div class="btn-group">
                        <a href="/admin/reset-student/<%= s._id %>" class="btn btn-sm btn-warning" onclick="return confirm('ØªØµÙÙŠØ± ÙƒÙ„ ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')">ØªØµÙÙŠØ±</a>
                        <a href="/admin/delete-student/<%= s._id %>" class="btn btn-sm btn-danger"><i class="fa fa-trash"></i></a>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr><td colspan="4" class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card-custom">
        <h5>ğŸ‘‘ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h5>
        <div class="mb-3">
          <% admins.forEach(a => { %>
            <div class="d-flex justify-content-between align-items-center p-2 bg-dark rounded mb-2">
              <div>
                <div class="small fw-bold"><%= a.username %></div>
                <div class="text-muted" style="font-size: 0.7rem;"><%= a.email %></div>
              </div>
              <% if(a.email !== 'admin@medo.com') { %>
                <a href="/admin/delete-admin/<%= a._id %>" class="text-danger"><i class="fa fa-user-minus"></i></a>
              <% } %>
            </div>
          <% }) %>
        </div>
        <hr>
        <h6>Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù† Ø¬Ø¯ÙŠØ¯</h6>
        <form action="/admin/add-admin" method="POST">
          <input type="text" name="username" class="form-control form-control-sm mb-2 bg-dark text-white" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
          <input type="email" name="email" class="form-control form-control-sm mb-2 bg-dark text-white" placeholder="Ø§Ù„Ø¬ÙŠÙ…ÙŠÙ„" required>
          <input type="password" name="password" class="form-control form-control-sm mb-2 bg-dark text-white" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯" required>
          <button class="btn btn-success btn-sm w-100">Ø¥Ø¶Ø§ÙØ© ÙƒØ£Ø¯Ù…Ù†</button>
        </form>
      </div>
    </div>
  </div>

  <div class="card-custom">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5>ğŸ“š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h5>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCourseModal">ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯ +</button>
    </div>
    <div class="row">
      <% courses.forEach(c => { %>
        <div class="col-md-6 mb-3">
          <div class="p-3 rounded border border-secondary bg-dark">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="text-info"><%= c.title %></h6>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-light" onclick="openEditModal('<%= c._id %>', '<%= c.title %>', '<%= c.thumb %>')"><i class="fa fa-edit"></i></button>
                <a href="/admin/delete-course/<%= c._id %>" class="btn btn-sm btn-outline-danger"><i class="fa fa-trash"></i></a>
              </div>
            </div>
            <div class="lectures-list" style="max-height: 150px; overflow-y: auto;">
              <% c.lectures.forEach((l, index) => { %>
                <div class="d-flex justify-content-between small p-1 border-bottom border-secondary">
                  <span><%= index+1 %>. <%= l.title %></span>
                  <a href="/admin/delete-lecture/<%= c._id %>/<%= index %>" class="text-danger"><i class="fa fa-times"></i></a>
                </div>
              <% }) %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <div class="card-custom">
    <h5>ğŸ”” Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø«</h5>
    <div class="list-group list-group-flush bg-transparent" style="max-height: 300px; overflow-y: auto;">
      <% notifications.forEach(n => { %>
        <div class="list-group-item bg-transparent text-white notify-item" 
             onclick="showNotifyDetail('<%= n.type %>', '<%= n.message %>', '<%= n.createdAt.toLocaleString() %>')">
          <div class="d-flex w-100 justify-content-between">
            <strong class="mb-1 text-warning"><%= n.type %></strong>
            <small class="text-muted"><%= n.createdAt.toLocaleTimeString() %></small>
          </div>
          <p class="mb-1 small"><%= n.message %></p>
        </div>
      <% }) %>
    </div>
  </div>
</div>

<div class="modal fade" id="editCourseModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editForm" method="POST" class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary"><h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³</h5></div>
      <div class="modal-body">
        <label class="small">Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³</label>
        <input type="text" name="title" id="editTitle" class="form-control bg-secondary text-white mb-2">
        <label class="small">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label>
        <input type="text" name="thumb" id="editThumb" class="form-control bg-secondary text-white">
      </div>
      <div class="modal-footer border-secondary">
        <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function openEditModal(id, title, thumb) {
    document.getElementById('editForm').action = '/admin/edit-course/' + id;
    document.getElementById('editTitle').value = title;
    document.getElementById('editThumb').value = thumb;
    new bootstrap.Modal(document.getElementById('editCourseModal')).show();
  }

  function showNotifyDetail(type, msg, time) {
    alert(`ğŸ“Œ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ${type}\nğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${msg}\nâ° Ø§Ù„ÙˆÙ‚Øª: ${time}`);
  }
</script>
</body>
</html>
